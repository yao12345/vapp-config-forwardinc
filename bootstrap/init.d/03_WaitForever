echo "[*] Finished and detecting any new changes..."

ETCD_SERVICE=http://dxgrid-discovery:2379

while [ True ]; do
echo "now is...."
date
echo "Waiting for new changes from the ETCD service..."
/usr/bin/curl "http://dxgrid-discovery:2379/v2/keys/dxgrid-forwardinc?wait=true&recursive=true"
echo "Detected new changes from the ETCD service, updating the config files..."
echo "===================================================="

# Get the JSON formatted data from etcd for each DSA
PRIMARY_ROUTER_JSON=`/usr/bin/curl -s -L $ETCD_SERVICE/v2/keys/dxgrid-forwardinc/primary-router`
PRIMARY_DATA_JSON=`/usr/bin/curl -s -L $ETCD_SERVICE/v2/keys/dxgrid-forwardinc/primary-data`
SECONDARY_ROUTER_JSON=`/usr/bin/curl -s -L $ETCD_SERVICE/v2/keys/dxgrid-forwardinc/secondary-router`
SECONDARY_DATA_JSON=`/usr/bin/curl -s -L $ETCD_SERVICE/v2/keys/dxgrid-forwardinc/secondary-data`

# Obtain the IP addresses from the JSON string
PRIMARY_ROUTER_DSA_IP=`echo $PRIMARY_ROUTER_JSON | grep -Po '"value":.*?[^\\\\]"' | awk -F '"' '{ print $4 }'`
PRIMARY_DATA_DSA_IP=`echo $PRIMARY_DATA_JSON | grep -Po '"value":.*?[^\\\\]"' | awk -F '"' '{ print $4 }'`
SECONDARY_ROUTER_DSA_IP=`echo $SECONDARY_ROUTER_JSON | grep -Po '"value":.*?[^\\\\]"' | awk -F '"' '{ print $4 }'`
SECONDARY_DATA_DSA_IP=`echo $SECONDARY_DATA_JSON | grep -Po '"value":.*?[^\\\\]"' | awk -F '"' '{ print $4 }'`

#source ./02_ProcessConfig

KNOWLEDGE_ORG_DIR=/solution/dxgrid-forwardinc/common/knowledge_org
KNOWLEDGE_DIR=/solution/dxgrid-forwardinc/common/knowledge

# Overwrite the common knowleged folder
echo "Overwritting the common knowleged folder with the original ones..."
cp -r $KNOWLEDGE_ORG_DIR/* $KNOWLEDGE_DIR 

# Replace IP addresses
sed -i "s/\$PRIMARY_ROUTER_DSA_IP/$PRIMARY_ROUTER_DSA_IP/g" $KNOWLEDGE_DIR/*.dxc
sed -i "s/\$PRIMARY_DATA_DSA_IP/$PRIMARY_DATA_DSA_IP/g" $KNOWLEDGE_DIR/*.dxc

sed -i "s/\$SECONDARY_ROUTER_DSA_IP/$SECONDARY_ROUTER_DSA_IP/g" $KNOWLEDGE_DIR/*.dxc
sed -i "s/\$SECONDARY_DATA_DSA_IP/$SECONDARY_DATA_DSA_IP/g" $KNOWLEDGE_DIR/*.dxc

echo "[*] Updated knowledge files:"
cat $KNOWLEDGE_DIR/*


touch /solution/.configured

done

#tail -f /dev/null

echo "[*] Exiting"
